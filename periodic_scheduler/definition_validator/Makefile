# Generated by usvc-1.13.1
# Feel free to adjust, it will not be overridden

.PHONY: image.build image.run image.test image.push image.pull
.PHONY: create-deploy deploy k8s-shell console watch lint
.PHONY: config-gen abort-on-uncommited-changes copy-mix.lock

ELIXIR_DOCKER_IMAGE=elixir:1.14

SEMAPHORE_EXECUTABLE_UUID?=""
GIT_HASH=$(shell git log --format=format:'%h' -1)
TAG?=$(GIT_HASH)-$(SEMAPHORE_EXECUTABLE_UUID)
REPO=renderedtext/ppl_definition_validator
IMAGE=$(REPO):$(TAG)
IMAGE_LATEST=$(REPO):latest

HOME_DIR=/home/dev
WORKDIR=$(HOME_DIR)/periodic
USER=dev
MIX_ENV=dev
INTERACTIVE_SESSION=\
          -e MIX_ENV=$(MIX_ENV) \
          -v $$PWD/home_dir:$(HOME_DIR) \
          -v $$PWD/..:$(WORKDIR) \
          --rm \
          --workdir=$(WORKDIR)/definition_validator \
          --user=$(USER) \
          -it $(ELIXIR_DOCKER_IMAGE)

CMD?=/bin/bash

console:
	docker run --network=host $(INTERACTIVE_SESSION) $(CMD)

image.build:
	docker build --cache-from $(IMAGE_LATEST) -t $(IMAGE) .
	docker tag $(IMAGE) $(IMAGE_LATEST)

image.run: image.build
	docker run -p 4000:4000 -it $(IMAGE)

# Container litens on different port
# (so that container and 'mix run' can run together)
image.test: image.build
	docker run --rm --name definition_validator -p 4004:4000 -d $(IMAGE)
	# run some tests...
	docker kill definition_validator

unit.test:
	$(MAKE) console USER="root" MIX_ENV=test \
          CMD="mix do local.hex --force, local.rebar --force, deps.get, test"

create-deploy: abort-on-uncommited-changes image.push config-gen
	kubectl create -f deploy.yml
	kubectl get svc/definition-validator

deploy: abort-on-uncommited-changes image.push config-gen
	kubectl apply -f deploy.yml
	kubectl get svc/definition

k8s-shell:
	$(eval pod_name=$(shell kubectl get po -l app=cluster-portal -o jsonpath={.items[*].metadata.name}))
	kubectl exec -it $(pod_name) -- /bin/bash

watch:
	docker run --network=host $(INTERACTIVE_SESSION)  mix do deps.get, test.watch

lint:
	$(MAKE) console CMD="mix do credo"

lint-root:
	$(MAKE) console USER=root CMD="mix do local.hex --force, local.rebar --force, deps.get, credo"

postgres.run:
	docker run -d --rm --name db --network=host postgres:9.6
	@echo "\nConnect with: 'psql -h localhost -U postgres'"

image.push: image.build
	docker push $(IMAGE)
	docker push $(IMAGE_LATEST)

image.pull:
	docker pull $(IMAGE)
	docker pull $(IMAGE_LATEST)

usvc.install:
	mix archive.install http://usvc.tools.renderedtext.com/usvc-1.13.1.ez --force

config-gen:
	mix usvc.cfg_gen $(TAG)

abort-on-uncommited-changes:
	git diff-index --quiet HEAD --
